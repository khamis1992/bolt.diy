# شروط التطوير لمشروع bolt.diy

> هذا المستند مرجع إلزامي لأي مساهم أو وكيل ذكاء اصطناعي يعمل على المستودع. اقرأه بالكامل قبل البدء، وارجع إليه عند كل تعديل أو إضافة خدمة جديدة.

## 1. نظرة عامة على المعمارية

### 1.1 طبقة الواجهة (Front-End)
- يعتمد المشروع على **Remix** مع **React 18** وبيئة بناء Vite، وتتم تهيئة الشجرة الرئيسية في `app/root.tsx`، حيث يتم ضبط السمات، وتحميل الأنماط العالمية، وتهيئة مزودي DnD، وتسجيل أحداث السجل عند الإقلاع. 【F:app/root.tsx†L1-L74】【F:app/root.tsx†L90-L118】
- يتم تجميع الأنماط عبر **UnoCSS** مع مكتبة أيقونات مخصصة وألوان معرفة في `uno.config.ts`. يجب إعادة استخدام الألوان والاختصارات المعتمدة وعدم إدخال متغيرات نمطية عشوائية. 【F:uno.config.ts†L1-L104】

### 1.2 إدارة الحالة والتخزين
- تستعمل الواجهة **Nanostores** لتخزين الحالة مثل `themeStore`، `chatStore`، و`workbenchStore`. يحظر إنشاء مخازن متداخلة جديدة قبل التأكد من عدم وجود مخزن يغطي نفس المجال. 【F:app/components/chat/Chat.client.tsx†L1-L64】【F:app/lib/stores/workbench.ts†L1-L20】
- يتم حفظ سجل المحادثة على المتصفح عبر طبقة `~/lib/persistence`. أي تعديل في آليات التخزين يجب أن يحافظ على واجهة التخزين المستخدمة في `useChatHistory`. 【F:app/components/chat/Chat.client.tsx†L24-L47】

### 1.3 خط سير المحادثة مع المزودات
- مكون المحادثة الرئيسي يستخدم `useChat` من حزمة `@ai-sdk/react` لإرسال الرسائل إلى مسار `POST /api/chat`، مع حقن ملفات المشروع، إعدادات المزودات، وخيارات تحسين السياق. حافظ على تطابق بنية الطلب عند أي تعديل. 【F:app/components/chat/Chat.client.tsx†L65-L134】
- المسار `app/routes/api.chat.ts` يشكل نقطة الدخول للخادم: يتم تحليل الطلب، تطبيق الاسترجاع، اختيار الملفات ذات الصلة، إنشاء ملخص للمحادثة، ثم بث الاستجابة عبر `SwitchableStream`. أي خدمة جديدة للمحادثة يجب أن تعيد استخدام نفس البنية للحفاظ على التوافق مع الواجهة. 【F:app/routes/api.chat.ts†L1-L126】【F:app/routes/api.chat.ts†L133-L212】

### 1.4 بيئة WebContainer
- يتم تشغيل بيئة العمل المتكاملة عبر `@webcontainer/api` مع سكربت فحص أخطاء معاينة مخصص في `app/lib/webcontainer/index.ts`. عند إضافة أوامر جديدة أو ضبط خاصية في WebContainer تأكد من تحديث متجر `workbenchStore` لمعالجة التنبيهات. 【F:app/lib/webcontainer/index.ts†L1-L67】

### 1.5 الخدمات والتكاملات الخارجية
- الخدمات الخاصة بالتكامل (GitHub, GitLab, Netlify, Vercel, Supabase, MCP) موجودة في `app/lib/services`. مثال: `githubApiService.ts` يوفر طبقة استدعاء متسقة مع واجهات GitHub ويجب الاستناد إليه بدلاً من استدعاءات `fetch` مباشرة. 【F:app/lib/services/githubApiService.ts†L1-L80】

### 1.6 الأمان والتهيئة
- استخدم أدوات الأمن الموحدة: مراقبة معدل الاستدعاء، رؤوس الحماية، ومعالجة رسائل الخطأ متوفرة في `app/lib/security.ts`. أي مسار جديد يجب أن يطبق هذه الأدوات قبل إرسال الاستجابة. 【F:app/lib/security.ts†L1-L84】【F:app/lib/security.ts†L86-L140】
- مفاتيح البيئة والتكاملات يجب أن تُدار عبر `.env.local`، ويعرض الملف `.env.example` جميع المفاتيح المتاحة وملاحظات استخدامها. لا تُخزن القيم الحساسة في الشيفرة. 【F:.env.example†L1-L84】
- الثوابت المركزية (مثل مسار عمل WebContainer، النماذج الافتراضية، وقائمة القوالب) معرّفة في `app/utils/constants.ts`. يجب إعادة استخدام هذه الثوابت وعدم تكرارها. 【F:app/utils/constants.ts†L1-L87】【F:app/utils/constants.ts†L89-L170】

## 2. هيكل المستودع الأساسي
- `app/`: مصادر الواجهة والمسارات، وتشمل `components/`, `routes/`, `lib/`, `utils/`, `styles/`.
- `app/lib/`: وحدات العمل المشتركة (API، خدمات، مخازن، أدوات أمان، إدارة LLM، WebContainer).
- `app/routes/`: مسارات Remix للخادم (Endpoints REST-like وواجهات SPA).
- `electron/`: شفرة الحزم الخاصة بتطبيق سطح المكتب.
- `docs/`: توثيق رسمي (MkDocs). أضف الوثائق الجديدة هنا إذا كانت مرجعية دائمة.
- `scripts/`: سكربتات مساعدة للتنظيف والبناء.
- `uno.config.ts`, `vite.config.ts`, `package.json`: ملفات التكوين للبناء والأدوات.

## 3. معايير التطوير العامة
1. **لغة البرمجة**: TypeScript إلزامي؛ حدد الأنواع بدقة، واستخدم `zod` أو الأنواع المحلية للتحقق عند الحاجة.
2. **التنسيق والجودة**:
   - استخدم `pnpm lint` للتأكد من التزام الشفرة بـ ESLint. 【F:package.json†L14-L38】
   - شغّل `pnpm test` و`pnpm typecheck` عند تعديل المنطق أو الأنواع. 【F:package.json†L14-L38】
   - أي شيفرة UI يجب أن تستفيد من اختصارات UnoCSS وتعريفات اللون الموحدة.
3. **التخزين والحالة**: قبل إنشاء مخزن أو سياق جديد، راجع `app/lib/stores` لتحديد ما إذا كان يمكن إعادة استخدام مخزن حالي أو توسيعه.
4. **المسارات**: لا تستخدم `fetch` المباشر داخل المكونات للوصول إلى APIs خارجية، بل مرر عبر خدمات `app/lib/services` ثم مسارات Remix.
5. **السجلات**: استخدم `createScopedLogger` من `~/utils/logger` لمراقبة السلوك بدلاً من `console.log`، إلا أثناء التصحيح المحلي.
6. **الرسائل والأخطاء**: مرر الأخطاء عبر `sanitizeErrorMessage` و`logStore` لتجنب تسريب بيانات حساسة. 【F:app/lib/security.ts†L112-L140】
7. **المفاتيح**: لا تعتمد على القيم المخزنة في `localStorage` إلا بعد التأكد من تهيئتها عبر الواجهة (الإعدادات) أو مسارات الخادم.

## 4. سير العمل عند إضافة ميزة أو خدمة جديدة
1. **التخطيط**: وثّق النطاق والنتيجة المتوقعة في بطاقة أو ملف Markdown داخل `docs/` قبل البدء.
2. **تهيئة البيانات**:
   - أضف أي مفاتيح جديدة إلى `.env.example` مع شرح واضح.
   - أضف الثوابت الخاصة بالخدمة في `app/utils/constants.ts` أو ملف متخصص داخل `app/lib/modules/`.
3. **الواجهة**:
   - أضف المكونات داخل مجلد مناسب تحت `app/components/`. حافظ على فصل المنطق عن العرض باستخدام hooks في `app/lib/hooks/`.
   - حدّث المتاجر المعنية (`app/lib/stores/...`) وتأكد من أن الحالة قابلة للتسلسل عند الحاجة للتخزين المحلي أو للمزامنة مع WebContainer.
4. **المسارات والخدمات**:
   - أنشئ ملف خدمة جديد داخل `app/lib/services` للوصول الخارجي.
   - أضف أو عدّل مسار Remix داخل `app/routes` مع استدعاء `checkRateLimit` و`createSecurityHeaders` عند الضرورة.
   - استخدم `SwitchableStream` و`streamText` عند الحاجة إلى بث استجابات LLM. 【F:app/routes/api.chat.ts†L1-L126】
5. **التكامل مع WebContainer** (عند الحاجة): حدّث `app/lib/webcontainer/index.ts` لضبط السلوك، وتأكد من إرسال التنبيهات عبر `workbenchStore`. 【F:app/lib/webcontainer/index.ts†L1-L67】
6. **الاختبارات**: أضف أو عدّل اختبارات Vitest (ضمن `app/lib/runtime` أو مسارات أخرى) وتحقق من نجاحها.
7. **المراجعة**: قدم وصفًا واضحًا في PR، وأدرج خطوات التحقق اليدوي، وارتبط بالوثائق أو بطاقات التخطيط.

## 5. إضافة مزود LLM جديد
1. أنشئ ملفًا داخل `app/lib/modules/llm/providers` يطبق واجهة المزود المعتمدة (راجع المزودات الموجودة مثل `openai.ts`).
2. سجّل المزود في مدير LLM عبر `LLMManager` لضمان ظهوره في `PROVIDER_LIST` و`DEFAULT_PROVIDER`. 【F:app/utils/constants.ts†L1-L30】
3. أضف إعدادات الواجهة في شاشة المزودات ضمن إعدادات التطبيق (تعديل المخزن أو المكون المناسب داخل `app/components/@settings`).
4. حدّث `.env.example` بمفاتيح المزود، مع الإشارة إلى صيغة المفتاح ورابط الحصول عليه. 【F:.env.example†L1-L84】
5. عند الحاجة إلى خيارات متقدمة (سيرفر وسيط، سياق إضافي)، حدّث `app/routes/api.chat.ts` لضبط التهيئة أو تمرير حقول جديدة في الجسم.

## 6. إرشادات خاصة للوكلاء (LLM / أدوات التوليد الآلي)
- التزم بهذا المستند كمرجع قبل القيام بأي تعديل تلقائي.
- لا تقم بتعديل أكثر من مجال واحد في خطوة واحدة دون تحديث مستودع التخطيط.
- احرص على قراءة وفهم الملفات المتأثرة بالكامل قبل اقتراح تغييرات عليها.
- بعد كل تعديل، شغّل الأدوات الآلية (`pnpm lint`, `pnpm test`, `pnpm typecheck`) إن كان التغيير يتجاوز الوثائق.
- اكتب رسائل الالتزام بصيغة واضحة تصف النتيجة (مثال: `feat: support NewProvider auth flow`).

## 7. تفعيل وضع SaaS المتعدد المستأجرين
- تمت إضافة طبقة خدمية جديدة تحت `app/lib/server/` تتعامل مع قاعدة بيانات **Cloudflare D1**.
  - `db.server.ts`: يوفّر الوصول الموحّد إلى الربط `BOLT_DB` ويُطلق خطأً واضحًا إذا لم يتم تكوينه.
  - `saas.server.ts`: يحتوي على المنطق الخاص بالمساحات (Workspaces)، المفاتيح، والأعضاء، بما في ذلك توليد المفاتيح وتجزئتها.
  - `session.server.ts`: يدير جلسات الكعكات (cookies) باستخدام `SESSION_SECRET` ويعيد بيانات الجلسة بعد التحقق.
- تم توسيع حمولة الجذر (`app/root.tsx`) لتحميل حالة الجلسة وحقنها في الواجهة. استخدم `useRouteLoaderData<typeof loader>('root')` للوصول إلى `RootLoaderData` من أي مكوّن.
- تمت إضافة شاشة تسجيل الدخول `app/components/auth/LoginScreen.tsx` ومكوّن `AccountMenu` في الهيدر لعرض بيانات المساحة وتسجيل الخروج.
- واجهات REST الجديدة:
  - `POST /api/saas/workspaces`: إنشاء مساحة جديدة بعد التحقق من رمز المشرف (`SAAS_ADMIN_TOKEN`). تعيد المفتاح المولد مع بيانات المساحة.
  - `GET/POST/DELETE /api/saas/session`: إدارة تسجيل الدخول والخروج وإرجاع حالة الجلسة الحالية.
- عند تفعيل المتغير `SAAS_MODE=true` يجب توفير القيم التالية في البيئة:
  - `BOLT_DB`: ربط قاعدة بيانات D1 مع تطبيق الترقيات `migrations/0001_init_saas.sql`.
  - `SESSION_SECRET`: سلسلة عشوائية (32+ حرفًا) لتوقيع ملفات تعريف الارتباط.
  - `SAAS_ADMIN_TOKEN`: مفتاح إداري آمن لإنشاء المساحات.
- للتطوير المحلي مع هذه البنية، استخدم `wrangler pages dev` بدلاً من `pnpm dev` لضمان توفر ربط Cloudflare والسياق داخل محمل Remix.
- تم تقييد مسار `POST /api/chat` ليطلب جلسة صالحة عندما يكون وضع SaaS مفعلاً. تأكد من معالجة الجلسة أولًا في أي مسار جديد حساس.

## 7. سياسات الأمان والخصوصية
- جميع البيانات الحساسة (مفاتيح، رموز وصول) يجب أن تبقى خارج المستودع. استخدم التخزين المحلي الآمن أو السرّيات في منصات النشر (Cloudflare Pages أو Electron).
- عند تسجيل الأخطاء، استخدم `sanitizeErrorMessage` لإخفاء البيانات الحساسة، واحتفظ برسائل عامة للمستخدم النهائي. 【F:app/lib/security.ts†L112-L140】
- تحقق من حدود الاستدعاء (`checkRateLimit`) قبل كل طلب خارجي لتجنب تعطيل الخدمة. 【F:app/lib/security.ts†L1-L84】

## 8. الاختبارات والتحقق قبل الدمج
- للتأكد من الاستقرار، قم بتشغيل:
  - `pnpm lint`
  - `pnpm typecheck`
  - `pnpm test`
- أرفق في طلب الدمج نتائج الأوامر ولقطات الشاشة أو تسجيلات عند تعديل واجهة المستخدم.

## 9. توثيق التغييرات
- أي ميزة أو خدمة جديدة يجب أن تُوثق في `docs/` أو `README.md` بحسب السياق.
- احتفظ بقائمة محدثة للقوالب، التكاملات، والمزودات في الوثائق لضمان اتساق تجربة المستخدم.

باتباع هذه الشروط، نحافظ على جودة مشروع bolt.diy واستقراره، ونضمن قدرة المساهمين والبوتات على توسيعه بثقة وبدون مفاجآت.
